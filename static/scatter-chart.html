<link rel="import" href="/components/polymer/polymer.html">


<polymer-element name="scatter-chart" attributes="variants">
    <template>
        <style>
            :host {
                display: block;
                position: relative;
                background-color: white;
                width: 100%;
            }
            .axis path,
            .axis line {
                fill: none;
                stroke: #000;
                shape-rendering: crispEdges;
            }

            .dot {
                stroke: #000;
            }

        </style>
        <core-signals on-core-signal-numchanged="{{numchanged}}"></core-signals>
        <div class="container" layout horizontal center>
            <svg id="scatterChart"></svg>
        </div>
    </template>
    <script>
        Polymer({
            created: function() {
                // hint that items is an array
                this.scenNumber = 0;
                this.variants = [];
                this.dataSet = [];
            },
            costFunction: function(prob, impact){
                return prob;
            },
            numchanged: function(e, detail, sender) {
                d3.select(this.$.scatterChart).selectAll("*").remove();
                this.redraw()
            },
            ready: function(){

            },
            rebuildDataSet: function(){
                this.scenNumber = Math.pow(2, this.variants.length)
                this.dataSet.length = this.scenNumber
                for (var scenario = 0; scenario < this.scenNumber; scenario++){
                    var obj = {id: scenario, prob: 1, impact: 0, weight: 0, endpoints: []}
                    for (var factor = 0; factor < this.variants.length; factor++){
                        var ep = (scenario & (1 << factor ) ) > 0 ? 1 : 0
                        obj.endpoints.push(ep)
                        obj.impact -= -this.variants[factor].endpoints[ep].impact;
                        obj.prob *= this.variants[factor].endpoints[ep].prob;
                    }
                    obj.weight = this.costFunction(obj.weight, obj.prob);
                    this.dataSet[scenario] = obj;
                }
            },
            redraw: function(){
                this.rebuildDataSet();
                var margin = {top: 20, right: 20, bottom: 30, left: 40},
                        width = 960 - margin.left - margin.right,
                        height = 500 - margin.top - margin.bottom;

                var x = d3.scale.linear()
                        .range([0, width]);

                var y = d3.scale.linear()
                        .range([height, 0]);

                var color = d3.scale.category20b();

                var xAxis = d3.svg.axis()
                        .scale(x)
                        .orient("bottom");

                var yAxis = d3.svg.axis()
                        .scale(y)
                        .orient("left");

                var svg = d3.select("body").append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                var data = this.dataSet

//                d3.tsv("data.tsv", function(error, data) {
//                    data.forEach(function(d) {
//                        d.sepalLength = +d.sepalLength;
//                        d.sepalWidth = +d.sepalWidth;
//                    });

                    x.domain(d3.extent(data, function(d) { return d.impact; })).nice();
                    y.domain(d3.extent(data, function(d) { return d.prob; })).nice();

                    svg.append("g")
                            .attr("class", "x axis")
                            .attr("transform", "translate(0," + height + ")")
                            .call(xAxis)
                            .append("text")
                            .attr("class", "label")
                            .attr("x", width)
                            .attr("y", -6)
                            .style("text-anchor", "end")
                            .text("Sepal Width (cm)");

                    svg.append("g")
                            .attr("class", "y axis")
                            .call(yAxis)
                            .append("text")
                            .attr("class", "label")
                            .attr("transform", "rotate(-90)")
                            .attr("y", 6)
                            .attr("dy", ".71em")
                            .style("text-anchor", "end")
                            .text("Sepal Length (cm)")

                var colours = ["#6363FF", "#6373FF", "#63A3FF", "#63E3FF", "#63FFFB", "#63FFCB",
                    "#63FF9B", "#63FF6B", "#7BFF63", "#BBFF63", "#DBFF63", "#FBFF63",
                    "#FFD363", "#FFB363", "#FF8363", "#FF7363", "#FF6364"];

                var heatmapColour = d3.scale.linear()
                        .domain(d3.range(0, 1, 1.0 / (colours.length - 1)))
                        .range(colours);


                var c = d3.scale.linear().domain(d3.extent(data.map(function(d){return d.impact}))).range([0,1]);

                    svg.selectAll(".dot")
                            .data(data)
                            .enter().append("circle")
                            .attr("class", "dot")
                            .attr("r", 3.5)
                            .attr("cx", function(d) { return x(d.impact); })
                            .attr("cy", function(d) { return y(d.prob); })
                            .style("fill", function(d) {
                                return color(d.impact);
                            });

                    var legend = svg.selectAll(".legend")
                            .data(color.domain())
                            .enter().append("g")
                            .attr("class", "legend")
                            .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

                    legend.append("rect")
                            .attr("x", width - 18)
                            .attr("width", 18)
                            .attr("height", 18)
                            .style("fill", color);

                    legend.append("text")
                            .attr("x", width - 24)
                            .attr("y", 9)
                            .attr("dy", ".35em")
                            .style("text-anchor", "end")
                            .text(function(d) { return d; });

//                });
            },
            variantsChanged: function(oldVal, newVal) {
                if (newVal.length == 0) return;
                this.redraw()
            }
        });
    </script>
</polymer-element>
