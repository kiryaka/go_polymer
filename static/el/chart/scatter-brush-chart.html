
<polymer-element name="scatter-brush-chart" attributes="rawdata variants">
    <template>
        <style shim-shadowdom>
            :host{
                display: block;
            }
            .axis path,
            .axis line {
                fill: none;
                stroke: #000;
                shape-rendering: crispEdges;
            }

            svg {
                font: 10px sans-serif;
            }

            text{
                fill: #666;
            }

            .grid .tick {
                stroke: lightgrey;
                opacity: 0.5;
            }

            .tick line {
                stroke: lightgrey;
                opacity: 0.5;
            }

            line {
                pointer-events: none;
            }

            .point {
                fill: #999;
                stroke: #fff;
            }

            .point.selected {
                fill: red;
                fill-opacity: 1;
                stroke: brown;
            }

            .brush .extent {
                stroke: #666;
                fill-opacity: .125;
                shape-rendering: crispEdges;
            }


        </style>

        <div id="map"></div>
    </template>

    <script>
        Polymer({
            ready: function(){

            },
            redraw: function(){

                var margin = {top: 20, right: 30, bottom: 30, left: 20},
                        width = 550 - margin.left - margin.right,
                        height = 200 - margin.top - margin.bottom;


                var x = d3.scale.linear()
                        .domain(d3.extent(this.rawdata, function(d) { return d.budget; })).nice()
                        .range([0, width]);

                var y = d3.scale.linear()
                        .domain(d3.extent(this.rawdata, function(d) { return d.affAbility; })).nice()
                        .range([height, 0]);

                var data = this.rawdata.map(function(d) { return [x(d.budget),y(d.affAbility)]; });

                var quadtree = d3.geom.quadtree()
                        .extent([[-1, -1], [width + 1, height + 1]])
                (data);

                var xAxis = d3.svg.axis()
                        .scale(x)
                        .orient("bottom")
                        .ticks(20);

                var yAxis = d3.svg.axis()
                        .scale(y)
                        .orient("left")
                        .ticks(10);

                var brush = d3.svg.brush()
                        .x(x)
                        .y(y)
                        .on("brush", brushed)
                        .on("brushend", brushended);

                var svg = d3.select(this.$.map).append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                var point = svg.selectAll(".point")
                        .data(data)
                        .enter().append("circle")
                        .attr("class", "point")
                        .attr("cx", function(d) { return d[0]; })
                        .attr("cy", function(d) { return d[1]; })
                        .attr("r", 4);

                svg.append("g")
                        .attr("class", "brush")
                        .call(brush)
                        .call(brush.event);

                function brushed() {
                    var extent = brush.extent();
                    point.each(function(d) { d.selected = false; });
                    search(quadtree, extent[0][0], extent[0][1], extent[1][0], extent[1][1]);
                    point.classed("selected", function(d) { return d.selected; });
                }

                function brushended() {
                    if (!d3.event.sourceEvent) return; // only transition after input
//                    d3.select(this).transition()
//                            .duration(brush.empty() ? 0 : 750)
//                            .call(brush.extent(defaultExtent))
//                            .call(brush.event);
                }

                function search(quadtree, x0, y0, x3, y3) {
                    quadtree.visit(function(node, x1, y1, x2, y2) {
                        var p = node.point;
                        if (p) p.selected = (p[0] >= x0) && (p[0] < x3) && (p[1] >= y0) && (p[1] < y3);
                        return x1 >= x3 || y1 >= y3 || x2 < x0 || y2 < y0;
                    });
                }

                svg.append("g")
                        .attr("class", "x axis")
                        .attr("transform", "translate(0," + y(0) + ")")
//                        .attr("transform", "translate(0," + height + ")")
                        .call(xAxis);

                svg.append("g")
                        .attr("class", "y axis")
                        .attr("transform", "translate(" + x(0) + ", 0)")
                        .call(yAxis);

                var numberOfTicks = 10;

                var yAxisGrid = yAxis.ticks(numberOfTicks)
                        .tickSize(width, 0)
                        .tickFormat("")
                        .orient("right");

                var xAxisGrid = xAxis.ticks(numberOfTicks)
                        .tickSize(-height, 0)
                        .tickFormat("")
                        .orient("top");

                svg.append("g")
                        .classed('y', true)
                        .classed('grid', true)
                        .call(yAxisGrid);

                svg.append("g")
                        .classed('x', true)
                        .classed('grid', true)
                        .call(xAxisGrid);
            },
            rawdataChanged: function(o, n){
                if (n && n.length > 0){
                    this.redraw();
                }
            }
        });
    </script>
</polymer-element>